---
title: Data check
author: Masatoshi Katabuchi
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
#rmdformats::material
  html_document:
    fig_caption: yes
    theme: spacelab #readable #sandstone #spacelab #flatly
    highlight: pygments #tango #kate
    toc: TRUE
    toc_depth: 2
    number_sections: TRUE
    toc_float:
      collapsed: TRUE
      smooth_scroll: TRUE
      toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, data, message=FALSE}
library(tidyverse)
library(GGally)
library(tictoc)
theme_set(theme_light())

#seedling_all <- read_csv("../data/seedling_for_drought.csv")
seedling_all <- read_csv("../data/seedlingmatrix.csv") 
seedling_all  <- seedling_all %>%
  mutate(S_CONS = scale(CONS) %>% as.numeric) %>%
  mutate(S_CONA = scale(CONA) %>% as.numeric) %>%
  mutate(S_HETS = scale(HETS) %>% as.numeric) %>%
  mutate(S_HETA = scale(HETA) %>% as.numeric)

#trait <- read_csv("../data/BB_SeedlingTrait.csv")
trait <- read_csv("../data/trait SPcode.csv")

#trait <- trait %>% 
#  rename(StemD = WD)

```

missing values in the trait data.

```{r}

is.na(trait) %>% apply(., 2, sum)

```


# Covariance

## Demography

```{r demo-cov, cache=TRUE, message=FALSE, warning=FALSE}

seedling_all %>%
  dplyr::select(S_CONS, S_CONA, S_HETS, S_HETA) %>%
  ggpairs(.)

```

## Traits

### Distributions

```{r}
trait %>% 
  filter(SLA > 1000)
```

```{r}
trait %>% 
  pivot_longer(LDMC:tlp) %>%
  ggplot(., aes(value)) +
  geom_histogram() +
  facet_wrap(~ name, scales = "free")

trait %>% 
  pivot_longer(LDMC:tlp) %>%
  filter(value > 0) %>%
  ggplot(., aes(value)) +
  geom_histogram() +
  facet_wrap(~ name, scales = "free") +
  scale_x_log10()
```

### Pair plot

```{r trait-cov, cache=TRUE, message=FALSE, warning=FALSE, fig.width=12, fig.height=12}

trait2 <- trait %>%
#  filter(SPcode != "C42") %>%
  dplyr::select(-SPcode) %>%
  mutate(logLA = log(LA)) %>%
  mutate(logSLA = log(SLA)) %>%
  mutate(logLT = log(LT)) %>%
  mutate(logN = log(N)) %>%
  dplyr::select(-LA, -SLA, -LT, -N) 

tic()
ggpairs(trait2)
toc()

```

### PCA

*Original PCA*

```{r}
library(FactoMineR)
library(factoextra)

trait_pca <- prcomp(trait2 %>% 
                    na.omit, scale = TRUE, center = TRUE)

df <- facto_summarize(trait_pca, element = "var", 
                     result = c("coord", "contrib", "cos2"), axes = c(1,2))
colnames(df)[2:3] <-  c("x", "y")

# need this to calc scale
pca_ind <- get_pca_ind(trait_pca)
ind <- data.frame(pca_ind$coord[, c(1,2), drop=FALSE], stringsAsFactors = TRUE)
colnames(ind)<- c("x", "y")

# rescale variable coordinates
r <- min(
(max(ind[,"x"])-min(ind[,"x"])/(max(df[,"x"])-min(df[,"x"]))),
(max(ind[,"y"])-min(ind[,"y"])/(max(df[,"y"])-min(df[,"y"])))
)

```

```{r}
summary(trait_pca)
```

- `labels = FALSE`
- `mean.point = FALSE`

```{r}

fviz_pca_biplot(trait_pca, axes.linetype = "dotted", 
                col.var = "black", 
                geom = "text",
                alpha.ind = 0.4, 
                geom.ind = "point",
                addEllipses = FALSE,
                label = "var",
                mean.point = FALSE,
                repel = TRUE   # Avoid text overlapping
                ) 


```

```{r}
fviz_pca_biplot(trait_pca, axes.linetype = "dotted", 
                col.var = "black", 
                geom = "text",
                axes = c(1, 3),
                alpha.ind = 0.4, 
                geom.ind = "point",
                addEllipses = FALSE,
                label = "var",
                mean.point = FALSE,
                repel = TRUE   # Avoid text overlapping
                ) 
```

```{r}
fviz_pca_biplot(trait_pca, axes.linetype = "dotted", 
                col.var = "black", 
                geom = "text",
                axes = c(2, 3),
                alpha.ind = 0.4, 
                geom.ind = "point",
                addEllipses = FALSE,
                label = "var",
                mean.point = FALSE,
                repel = TRUE   # Avoid text overlapping
                ) 
```

```{r}

trait3 <- trait2 %>% 
  dplyr::select(WD, logSLA, logLT) %>%
  na.omit

trait_pca <- prcomp(trait3,
                  scale = TRUE, center = TRUE)

fviz_pca_biplot(trait_pca, axes.linetype = "dotted", 
                col.var = "black", 
                geom = "text",
                alpha.ind = 0.4, 
                geom.ind = "point",
                addEllipses = FALSE,
                label = "var",
                mean.point = FALSE,
                repel = TRUE   # Avoid text overlapping
                ) 
```

```{r, eval = TRUE}
qplot(data= trait2, x = logLA, y = tlp)
```

# Species-level model options

Collinearity will be fine except for stem density and SDMC. We will check the
following models.

All species
  - Full
  - removing StemD from the full model
  - removing SDMC from the full model
  - Intercept + PC1 + PC2 + PC3
