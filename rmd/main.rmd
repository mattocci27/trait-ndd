---
title: Seedling survival analysis
author: Masatoshi Katabuchi
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
#rmdformats::material
  html_document:
    fig_caption: yes
    theme: spacelab #readable #sandstone #spacelab #flatly
    highlight: pygments #tango #kate
    toc: TRUE
    toc_depth: 2
    number_sections: TRUE
    toc_float:
      collapsed: TRUE
      smooth_scroll: TRUE
      toc: true
---

```{r, echo = F}
rm(list = ls())
```

# Deps

```{r}
library(tidyverse)
library(rstan)
library(coefplot)
library(bayesplot)
options(mc.cores = parallel::detectCores())
```

# Model

```{r,eval = T}
writeLines(readLines("../model/model_ind.stan"))
```

# Load result

```{r}
load("../data2/dry_spab_50_model_ind.rda")
```

```{r}
print(fit, pars = c("gamma", "Omega", "lp__"))
```

# Coefplot for Dry seasons

```{r}

post <- as.data.frame(fit)

gammas <- str_c("gamma[",rep(1:2, each = 5), ",", 2:6,"]")
post_gamma <- post[, gammas]

par_names <- c(
  "SCON", 
  "ACON", 
  "SHET", 
  "AHET", 
  "Height",
  "WP on SCON", 
  "WP on ACON", 
  "WP on SHET", 
  "WP on AHET",
  "WP on Height"
)

colnames(post_gamma) <- par_names

mcmc_intervals(
  post_gamma,
 # pars = gammas,
  prob = 0,
  prob_outer = 0.95,
  point_est = "median"
) +
  xlab("Effects on seedling survival") +
  theme(
    axis.text = element_text(family = "sans"),
    axis.title = element_text(family = "sans"))

beta3 <- str_c("beta[", 1:n_sp_d, ",3]")
beta3 <- as.tibble(post[, beta3]) 
colnames(beta3) <- str_c("sp", 1:n_sp_d)

beta3_dat <- beta3 %>%
  gather(., "sp", "post")

beta3_dat2 <- beta3_dat %>%
  group_by(sp) %>%
  summarize(
    med = median(post),
    upr = quantile(post, 0.975),
    low = quantile(post, 0.0275)
  ) %>%
  ungroup()

WP_dat <- tibble(
  sp = str_c("sp", 1:n_sp_d),
  WP = list_dat_d$u[,2])

beta3_dat3 <- full_join(beta3_dat2, WP_dat, by = "sp")

ggplot(beta3_dat3, aes(x = WP)) +
  geom_point(aes(y = med)) +
  geom_point(aes(y = upr), col = "red") +
  geom_point(aes(y = low), col = "red")

```
