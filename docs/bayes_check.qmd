---
title: "Diagnostics for MCMC"
author: "Masatoshi Katabuchi"
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 12pt
format:
  html:
    theme: cosmo #readable #sandstone #spacelab #flatly
    # highlight: pygments #tango #kate
    toc: true
    toc-depth: 2
    number-sections: true
    smooth-scroll: true
    embed-resources: true
---

```{r global_options, include=FALSE}
library(knitr)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  cache = FALSE,
  fig.align = "center",
  fig.show = "hold"
)
```

```{r}
library(tidyverse)
library(targets)
library(bayesplot)
library(kableExtra)
library(here)
library(jsonlite)
source(here("R", "stan.R"))
```

# Model

- Season (2 combinations)
  - dry (`dry`)
  - rainy (`wet`)
- Rain effects (3 combinations)
  - without rain (`norain`)
  - no interaction with rain (`rain`)
  - with interaction of rain (`intrain`)
- Phylogeny effects (2 combinations)
  - with phylo (`phy`)
  - without phylo (`het`)
- The effect of abundance on NDD in all the models are based on basal area
  - Results for numbers of individuals are not shown in this file

For example,
`fit_summary_logistic_stan_data_wet_phy_intrain_ba`
indicates the model is based on rainy season, with phylogeny and with interactions of rains and density effects.

# MCMC diagnostics

```{r}
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_load(loo_list))

loo_names <- names(loo_list)

library(targets)
hoge <- tar_manifest()



hoge |>
  filter(str_detect(name, "simple"))


# loo_names[str_detect(loo_names, "dry")]
# str_which(loo_names, "dry")

loo_tbl <- tibble(model = names(loo_list)) |>
  mutate(elpd = map_dbl(loo_list, \(x)x$elpd_loo)) |>
  mutate(p_loo = map_dbl(loo_list, \(x)x$p_loo)) |>
  mutate(looic = map_dbl(loo_list, \(x)x$looic))
```


## Dry

abundance
```{r}
loo_tbl |>
  filter(str_detect(model, "dry")) |>
  filter(str_detect(model, "ab|ba")) |>
  arrange(-elpd) |>
  DT::datatable()
```

traits
```{r}
loo_tbl |>
  filter(str_detect(model, "dry")) |>
  filter(str_detect(model, "_n$|_nlog")) |>
  arrange(-elpd) |>
  DT::datatable()
```

## Shade

abundance
```{r}
loo_tbl |>
  filter(str_detect(model, "wet")) |>
  filter(str_detect(model, "ab|ba")) |>
  arrange(-elpd) |>
  DT::datatable()
```

traits
```{r}
loo_tbl |>
  filter(str_detect(model, "wet")) |>
  filter(str_detect(model, "_n$|_nlog")) |>
  arrange(-elpd) |>
  DT::datatable()
```

```{r, eval=FALSE}
loo::loo_compare(
  loo_list[[3]],
  loo_list[[6]])
loo_list[[3]]
loo_list[[6]]
tar_read(fit_summary_logistic_stan_data_dry_phy_intrain_ba) |>
  filter(str_detect(variable, "psi")) |>
  head(30) |>
  DT::datatable()

tar_read(test_summary_logistic_simple_stan_data_dry_het_intrain_ab) |>
  arrange(ess_bulk) |>
  filter(ess_bulk < 400) |>
  DT::datatable()

m1 <- tar_read(test_mcmc_logistic_simple_stan_data_dry_het_intrain_ab)
m2 <- tar_read(fit_mcmc_logistic_stan_data_dry_het_intrain_ab)
library(loo)
options(mc.cores = 24)

loo1 <- m1$loo()
loo2 <- m2$loo()
loo_compare(loo1, loo2)

s1 <- tar_read(test_summary_logistic_simple_stan_data_dry_het_intrain_ab)
d1 <- tar_read(stan_data_dry_het_intrain_ab)
print_summary_tbl(s1, d1, alpha = 0.05)

s2 <- tar_read(fit_summary_logistic_stan_data_dry_het_intrain_ab)
d2 <- tar_read(stan_data_dry_het_intrain_ab)
print_summary_tbl(s2, d2, alpha = 0.05)


tar_read(stan_data_dry_phy_intrain_ba) |>
  str()

# names(loo_listn)
```

```{r}
knitr::knit_exit()
```

```{r}
loo_fit_mcmc_logistic_stan_data_dry_het_intrain_ab
data_names[27]

values <- expand_grid(
  season = c("dry", "wet"),
  het = c("phy", "het"),
  rain = c("norain", "intrain", "rain"),
  ab = c("ab", "ba"))

data_names <- values |>
  mutate(data_names = str_c("stan_data", season, het, rain, ab, sep = "_")) |>
  pull(data_names)

mcmc_names <- values |>
  mutate(mcmc_names = str_c("fit_mcmc_logistic_", data_names)) |>
  pull(mcmc_names)

tmp <- tibble(mcmc_names, model = str_c("model", 1:24))



loo_dry <- loo::loo_compare(
  loo_list[[1]],
  loo_list[[2]],
  loo_list[[3]],
  loo_list[[4]],
  loo_list[[6]],
  loo_list[[6]],
  loo_list[[7]],
  loo_list[[8]],
  loo_list[[9]],
  loo_list[[10]],
  loo_list[[11]],
  loo_list[[12]])

loo_wet <- loo::loo_compare(
  loo_list[[13]],
  loo_list[[14]],
  loo_list[[16]],
  loo_list[[16]],
  loo_list[[17]],
  loo_list[[18]],
  loo_list[[19]],
  loo_list[[20]],
  loo_list[[21]],
  loo_list[[22]],
  loo_list[[23]],
  loo_list[[24]]
)

loo_dry <- loo_dry |>
  as.data.frame() |>
  mutate(model = rownames(loo_dry)) |>
  full_join(tmp |> head(12))

loo_wet <- loo_wet |>
  as.data.frame() |>
  mutate(model = rownames(loo_wet)) |>
  full_join(tmp |> head(12)) |>
  mutate(mcmc_names = str_replace_all(mcmc_names, "dry", "wet"))
```

## Best model for dry season

Larger `elpd_loo` indicates better models.

`r loo_dry |> filter(str_detect(mcmc_names, "ba")) |> head(1) |> pull(mcmc_names)`
is the best model for the dry season.

```{r}
loo_dry |>
  filter(str_detect(mcmc_names, "ba")) |>
  DT::datatable()
```

## Best model for rainy season

`r loo_wet |> filter(str_detect(mcmc_names, "ba")) |> head(1) |> pull(mcmc_names)`
is the best model for the rainy season.

```{r}
loo_wet |>
  filter(str_detect(mcmc_names, "ba")) |>
  DT::datatable()
```

- There are no divergent transitions

```{r, echo=FALSE}
diag_names <- str_replace_all(mcmc_names, "mcmc", "diagnostics")

tmp <- here("stan/diag.txt")
for (i in 1:24) {
  if (i == 1) {
    write_lines(
    "withr::with_dir(rprojroot::find_root('_targets.R'),",
    tmp, "\n", append = FALSE)
  } else {
    write_lines(
    "withr::with_dir(rprojroot::find_root('_targets.R'),",
    tmp, "\n", append = TRUE)
  }
  write_lines(
  paste0(
  "  targets::tar_read(",
   diag_names[i],
  ")) |>"),
    tmp, "\n", append = TRUE
  )
  write_lines("  div_check()",  tmp, "\n", append = TRUE)
}
```

```{r}
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_read(fit_diagnostics_logistic_stan_data_dry_phy_norain_ab)) |>
  div_check()
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_read(fit_diagnostics_logistic_stan_data_dry_phy_norain_ba)) |>
  div_check()
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_read(fit_diagnostics_logistic_stan_data_dry_phy_intrain_ab)) |>
  div_check()
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_read(fit_diagnostics_logistic_stan_data_dry_phy_intrain_ba)) |>
  div_check()
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_read(fit_diagnostics_logistic_stan_data_dry_phy_rain_ab)) |>
  div_check()
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_read(fit_diagnostics_logistic_stan_data_dry_phy_rain_ba)) |>
  div_check()
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_read(fit_diagnostics_logistic_stan_data_dry_het_norain_ab)) |>
  div_check()
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_read(fit_diagnostics_logistic_stan_data_dry_het_norain_ba)) |>
  div_check()
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_read(fit_diagnostics_logistic_stan_data_dry_het_intrain_ab)) |>
  div_check()
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_read(fit_diagnostics_logistic_stan_data_dry_het_intrain_ba)) |>
  div_check()
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_read(fit_diagnostics_logistic_stan_data_dry_het_rain_ab)) |>
  div_check()
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_read(fit_diagnostics_logistic_stan_data_dry_het_rain_ba)) |>
  div_check()
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_read(fit_diagnostics_logistic_stan_data_wet_phy_norain_ab)) |>
  div_check()
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_read(fit_diagnostics_logistic_stan_data_wet_phy_norain_ba)) |>
  div_check()
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_read(fit_diagnostics_logistic_stan_data_wet_phy_intrain_ab)) |>
  div_check()
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_read(fit_diagnostics_logistic_stan_data_wet_phy_intrain_ba)) |>
  div_check()
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_read(fit_diagnostics_logistic_stan_data_wet_phy_rain_ab)) |>
  div_check()
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_read(fit_diagnostics_logistic_stan_data_wet_phy_rain_ba)) |>
  div_check()
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_read(fit_diagnostics_logistic_stan_data_wet_het_norain_ab)) |>
  div_check()
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_read(fit_diagnostics_logistic_stan_data_wet_het_norain_ba)) |>
  div_check()
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_read(fit_diagnostics_logistic_stan_data_wet_het_intrain_ab)) |>
  div_check()
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_read(fit_diagnostics_logistic_stan_data_wet_het_intrain_ba)) |>
  div_check()
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_read(fit_diagnostics_logistic_stan_data_wet_het_rain_ab)) |>
  div_check()
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_read(fit_diagnostics_logistic_stan_data_wet_het_rain_ba)) |>
  div_check()
```

```{r}
# knitr::knit_exit()
```

```{r}
print_summary_tbl <- function(mcmc_summary, mcmc_stan_data, alpha = c(0.05, 0.01, 0.5)) {
  gamma_row <- mcmc_stan_data$x |> colnames()
  gamma_col <- mcmc_stan_data$u |> rownames()

  if (alpha == 0.05) {
    mcmc_summary <- mcmc_summary |>
     mutate(sig = ifelse(q2.5 * q97.5 > 0, "sig", "ns"))
  } else if (alpha == 0.1) {
    mcmc_summary <- mcmc_summary |>
     mutate(sig = ifelse(q5 * q95 > 0, "sig", "ns"))
  } else if (alpha == 0.5) {
    mcmc_summary <- mcmc_summary |>
     mutate(sig = ifelse(q25 * q75 > 0, "sig", "ns"))
  }

  mcmc_summary |>
    filter(str_detect(variable, "gamma")) |>
    filter(sig == "sig") |>
    mutate(gamma_row_num = str_split_fixed(variable,  "\\[|\\]|,", 4)[, 2] |>
      as.numeric()) |>
    mutate(gamma_col_num = str_split_fixed(variable,  "\\[|\\]|,", 4)[, 3] |>
      as.numeric()) |>
    mutate(ind_pred = gamma_row[gamma_row_num]) |>
    mutate(sp_pred = gamma_col[gamma_col_num]) |>
    dplyr::select(variable, ind_pred, sp_pred, q2.5, q5, q25, q50, q75, q95, q97.5) |>
    kbl() |>
    kable_styling(bootstrap_options = c("striped", "HOLD_position"))
}
```

```{r, echo=FALSE}
tmp <- here("stan/summary.txt")
summary_names <- str_replace_all(mcmc_names, "mcmc", "summary")
summary_names2 <- summary_names[str_detect(summary_names, "ba")]
data_names2 <- data_names[str_detect(data_names, "ba")]

for (i in 1:12) {
  if (i == 1) {
    write_lines(
    paste0(
    "## ", summary_names2[i], "\n\n",
    "```{r}\n",
    "s1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(", summary_names2[i],"))\n",
    "d1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(", data_names2[i],"))\n",
    "print_summary_tbl(s1, d1, alpha = 0.05)\n",
    "print_summary_tbl(s1, d1, alpha = 0.1)\n",
    "print_summary_tbl(s1, d1, alpha = 0.5)\n",
    "```\n"
    ),
    tmp, "\n", append = FALSE)
  } else {
    write_lines(
    paste0(
    "## ", summary_names2[i], "\n\n",
    "```{r}\n",
    "s1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(", summary_names2[i],"))\n",
    "d1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(", data_names2[i],"))\n",
    "print_summary_tbl(s1, d1, alpha = 0.05)\n",
    "print_summary_tbl(s1, d1, alpha = 0.1)\n",
    "print_summary_tbl(s1, d1, alpha = 0.5)\n",
    "```\n"
    ),
    tmp, "\n", append = TRUE)
  }
}
```

# gamma values

Note: The order is not based on better models.

`print_summary_tbl` with `alpha = 0.05`, `alpha = 0.1`, and `alpha = 0.5` return predictors that 95% and 90% and 50% CIs do not overlap with zero, respectively.

## fit_summary_logistic_stan_data_dry_phy_norain_ba

```{r}
s1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(fit_summary_logistic_stan_data_dry_phy_norain_ba))
d1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(stan_data_dry_phy_norain_ba))
print_summary_tbl(s1, d1, alpha = 0.05)
print_summary_tbl(s1, d1, alpha = 0.1)
print_summary_tbl(s1, d1, alpha = 0.5)
```

## fit_summary_logistic_stan_data_dry_phy_intrain_ba

```{r}
s1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(fit_summary_logistic_stan_data_dry_phy_intrain_ba))
d1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(stan_data_dry_phy_intrain_ba))
print_summary_tbl(s1, d1, alpha = 0.05)
print_summary_tbl(s1, d1, alpha = 0.1)
print_summary_tbl(s1, d1, alpha = 0.5)
```

## fit_summary_logistic_stan_data_dry_phy_rain_ba

```{r}
s1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(fit_summary_logistic_stan_data_dry_phy_rain_ba))
d1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(stan_data_dry_phy_rain_ba))
print_summary_tbl(s1, d1, alpha = 0.05)
print_summary_tbl(s1, d1, alpha = 0.1)
print_summary_tbl(s1, d1, alpha = 0.5)
```

## fit_summary_logistic_stan_data_dry_het_norain_ba

```{r}
s1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(fit_summary_logistic_stan_data_dry_het_norain_ba))
d1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(stan_data_dry_het_norain_ba))
print_summary_tbl(s1, d1, alpha = 0.05)
print_summary_tbl(s1, d1, alpha = 0.1)
print_summary_tbl(s1, d1, alpha = 0.5)
```

## fit_summary_logistic_stan_data_dry_het_intrain_ba

```{r}
s1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(fit_summary_logistic_stan_data_dry_het_intrain_ba))
d1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(stan_data_dry_het_intrain_ba))
print_summary_tbl(s1, d1, alpha = 0.05)
print_summary_tbl(s1, d1, alpha = 0.1)
print_summary_tbl(s1, d1, alpha = 0.5)
```

## fit_summary_logistic_stan_data_dry_het_rain_ba

```{r}
s1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(fit_summary_logistic_stan_data_dry_het_rain_ba))
d1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(stan_data_dry_het_rain_ba))
print_summary_tbl(s1, d1, alpha = 0.05)
print_summary_tbl(s1, d1, alpha = 0.1)
print_summary_tbl(s1, d1, alpha = 0.5)
```

## fit_summary_logistic_stan_data_wet_phy_norain_ba

```{r}
s1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(fit_summary_logistic_stan_data_wet_phy_norain_ba))
d1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(stan_data_wet_phy_norain_ba))
print_summary_tbl(s1, d1, alpha = 0.05)
print_summary_tbl(s1, d1, alpha = 0.1)
print_summary_tbl(s1, d1, alpha = 0.5)
```

## fit_summary_logistic_stan_data_wet_phy_intrain_ba

```{r}
s1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(fit_summary_logistic_stan_data_wet_phy_intrain_ba))
d1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(stan_data_wet_phy_intrain_ba))
print_summary_tbl(s1, d1, alpha = 0.05)
print_summary_tbl(s1, d1, alpha = 0.1)
print_summary_tbl(s1, d1, alpha = 0.5)
```

## fit_summary_logistic_stan_data_wet_phy_rain_ba

```{r}
s1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(fit_summary_logistic_stan_data_wet_phy_rain_ba))
d1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(stan_data_wet_phy_rain_ba))
print_summary_tbl(s1, d1, alpha = 0.05)
print_summary_tbl(s1, d1, alpha = 0.1)
print_summary_tbl(s1, d1, alpha = 0.5)
```

## fit_summary_logistic_stan_data_wet_het_norain_ba

```{r}
s1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(fit_summary_logistic_stan_data_wet_het_norain_ba))
d1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(stan_data_wet_het_norain_ba))
print_summary_tbl(s1, d1, alpha = 0.05)
print_summary_tbl(s1, d1, alpha = 0.1)
print_summary_tbl(s1, d1, alpha = 0.5)
```

## fit_summary_logistic_stan_data_wet_het_intrain_ba

```{r}
s1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(fit_summary_logistic_stan_data_wet_het_intrain_ba))
d1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(stan_data_wet_het_intrain_ba))
print_summary_tbl(s1, d1, alpha = 0.05)
print_summary_tbl(s1, d1, alpha = 0.1)
print_summary_tbl(s1, d1, alpha = 0.5)
```

## fit_summary_logistic_stan_data_wet_het_rain_ba

```{r}
s1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(fit_summary_logistic_stan_data_wet_het_rain_ba))
d1 <- withr::with_dir(rprojroot::find_root('_targets.R'), targets::tar_read(stan_data_wet_het_rain_ba))
print_summary_tbl(s1, d1, alpha = 0.05)
print_summary_tbl(s1, d1, alpha = 0.1)
print_summary_tbl(s1, d1, alpha = 0.5)
```

