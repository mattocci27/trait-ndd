---
title: "Diagnostics for MCMC"
author: "Masatoshi Katabuchi"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    fig_caption: yes
    theme: spacelab #readable #sandstone #spacelab #flatly
    highlight: pygments #tango #kate
    toc: TRUE
    toc_depth: 2
    number_sections: TRUE
    toc_float:
     collapsed: TRUE
     smooth_scroll: TRUE
     toc: true
---


```{r global_options, include=FALSE}
library(knitr)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  cache = FALSE,
  fig.align = "center",
  fig.show = "hold"
)
```


```{r}
library(tidyverse)
library(here)
```

```{r}
source(here("R", "stan.R"))
```

# Model

- traits
  - CN: model without CN and WD
  - WD: model without WD
  - PCA: model with PCA1-3

```{r}
expand_grid(
  season = c("dry", "wet"),
  traits = c("CN", "WD", "PCA"),
  interaction = c("with", "without"))
```

Stan code.

```{stan, file="stan/model_ind.stan", echo=TRUE, eval=FALSE, output.var="hoge"}
```


# Convergence

All the models have converged (Rhat < 1.1).

```{r}
targets::tar_load(fit_1_dry_cn_int_summary_model_ind)
targets::tar_load(fit_2_wet_cn_int_summary_model_ind)
targets::tar_load(fit_3_dry_wd_int_summary_model_ind)
targets::tar_load(fit_4_wet_wd_int_summary_model_ind)
targets::tar_load(fit_5_dry_cn_noint_summary_model_ind)
targets::tar_load(fit_6_wet_cn_noint_summary_model_ind)
targets::tar_load(fit_7_dry_wd_noint_summary_model_ind)
targets::tar_load(fit_8_wet_wd_noint_summary_model_ind)
targets::tar_load(fit_9_dry_pca_int_summary_model_ind)
targets::tar_load(fit_10_wet_pca_int_summary_model_ind)
targets::tar_load(fit_11_dry_pca_noint_summary_model_ind)
targets::tar_load(fit_12_wet_pca_noint_summary_model_ind)
```


```{r}
fit_1_dry_cn_int_summary_model_ind |> filter(rhat > 1.1)
fit_2_wet_cn_int_summary_model_ind |> filter(rhat > 1.1)
fit_3_dry_wd_int_summary_model_ind |> filter(rhat > 1.1)
fit_4_wet_wd_int_summary_model_ind |> filter(rhat > 1.1)
fit_5_dry_cn_noint_summary_model_ind |> filter(rhat > 1.1)
fit_6_wet_cn_noint_summary_model_ind |> filter(rhat > 1.1)
fit_7_dry_wd_noint_summary_model_ind |> filter(rhat > 1.1)
fit_8_wet_wd_noint_summary_model_ind |> filter(rhat > 1.1)
fit_9_dry_pca_int_summary_model_ind |> filter(rhat > 1.1)
fit_10_wet_pca_int_summary_model_ind |> filter(rhat > 1.1)
fit_11_dry_pca_noint_summary_model_ind |> filter(rhat > 1.1)
fit_12_wet_pca_noint_summary_model_ind |> filter(rhat > 1.1)
```


# Divergent transitions

```{r}
targets::tar_load(fit_1_dry_cn_int_diagnostics_model_ind)
targets::tar_load(fit_2_wet_cn_int_diagnostics_model_ind)
targets::tar_load(fit_3_dry_wd_int_diagnostics_model_ind)
targets::tar_load(fit_4_wet_wd_int_diagnostics_model_ind)
targets::tar_load(fit_5_dry_cn_noint_diagnostics_model_ind)
targets::tar_load(fit_6_wet_cn_noint_diagnostics_model_ind)
targets::tar_load(fit_7_dry_wd_noint_diagnostics_model_ind)
targets::tar_load(fit_8_wet_wd_noint_diagnostics_model_ind)
targets::tar_load(fit_9_dry_pca_int_diagnostics_model_ind)
targets::tar_load(fit_10_wet_pca_int_diagnostics_model_ind)
targets::tar_load(fit_11_dry_pca_noint_diagnostics_model_ind)
targets::tar_load(fit_12_wet_pca_noint_diagnostics_model_ind)
```

There were a few divergent transitions for model 10 (PCA with interactions for Rainy seasons) and model 12 (PCA without interactions for Rainy seasons).
I could increase `adapt_delta ` later but the current results look OK.

```{r}
div_check(fit_1_dry_cn_int_diagnostics_model_ind)
div_check(fit_2_wet_cn_int_diagnostics_model_ind)
div_check(fit_3_dry_wd_int_diagnostics_model_ind)
div_check(fit_4_wet_wd_int_diagnostics_model_ind)
div_check(fit_5_dry_cn_noint_diagnostics_model_ind)
div_check(fit_6_wet_cn_noint_diagnostics_model_ind)
div_check(fit_7_dry_wd_noint_diagnostics_model_ind)
div_check(fit_8_wet_wd_noint_diagnostics_model_ind)
div_check(fit_9_dry_pca_int_diagnostics_model_ind)
div_check(fit_10_wet_pca_int_diagnostics_model_ind)
div_check(fit_11_dry_pca_noint_diagnostics_model_ind)
div_check(fit_12_wet_pca_noint_diagnostics_model_ind)
```

# Model comparisons

## Dry seasons

PCA without interactions is the best model.
Model without CN and WD and withouth interactions (cn_noint) is the best for single traits models.

```{r}
targets::tar_load(dry_loo)
loo::loo_compare(
  dry_loo[[1]],
  wd_int = dry_loo[[2]],
  cn_noint = dry_loo[[3]],
  wd_noint = dry_loo[[4]],
  pca_int = dry_loo[[5]],
  pca_noint = dry_loo[[6]])
```

## Rainy seasons

PCA with interactions is the best model.
Model without WD and without interactions (cn_noint) is the best for single traits models.
Model without CN and WD looks OK too.

```{r}
targets::tar_load(wet_loo)
loo::loo_compare(
  wet_loo[[1]],
  wd_int = wet_loo[[2]],
  cn_noint = wet_loo[[3]],
  wd_noint = wet_loo[[4]],
  pca_int = wet_loo[[5]],
  pca_noint = wet_loo[[6]])
```

# Session information

```{r}
devtools::session_info()
```

