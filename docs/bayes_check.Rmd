---
title: "Diagnostics for MCMC"
author: "Masatoshi Katabuchi"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    fig_caption: yes
    theme: spacelab #readable #sandstone #spacelab #flatly
    highlight: pygments #tango #kate
    toc: TRUE
    toc_depth: 2
    number_sections: TRUE
    toc_float:
     collapsed: TRUE
     smooth_scroll: TRUE
     toc: true
---


```{r global_options, include=FALSE}
library(knitr)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  cache = FALSE,
  fig.align = "center",
  fig.show = "hold"
)
```


```{r}
library(tidyverse)
library(ggridges)
library(here)
```

```{r}
source(here("R", "stan.R"))
```

# Model

I compared 12 models for now.

- traits
  - CN: model without CN and WD
  - WD: model without WD
  - PCA: model with PCA1-3

```{r}
expand_grid(
  season = c("dry", "wet"),
  traits = c("CN", "WD", "PCA"),
  interaction = c("with", "without"))
```

Stan code.

```{stan, file="stan/model_ind.stan", echo=TRUE, eval=FALSE, output.var="hoge"}
```


# Convergence

All the models have converged (Rhat < 1.1).

```{r}
targets::tar_load(fit_1_dry_cn_int_summary_model_ind)
targets::tar_load(fit_2_wet_cn_int_summary_model_ind)
targets::tar_load(fit_3_dry_wd_int_summary_model_ind)
targets::tar_load(fit_4_wet_wd_int_summary_model_ind)
targets::tar_load(fit_5_dry_cn_noint_summary_model_ind)
targets::tar_load(fit_6_wet_cn_noint_summary_model_ind)
targets::tar_load(fit_7_dry_wd_noint_summary_model_ind)
targets::tar_load(fit_8_wet_wd_noint_summary_model_ind)
targets::tar_load(fit_9_dry_pca_int_summary_model_ind)
targets::tar_load(fit_10_wet_pca_int_summary_model_ind)
targets::tar_load(fit_11_dry_pca_noint_summary_model_ind)
targets::tar_load(fit_12_wet_pca_noint_summary_model_ind)
```


```{r}
fit_1_dry_cn_int_summary_model_ind |> filter(rhat > 1.1)
fit_2_wet_cn_int_summary_model_ind |> filter(rhat > 1.1)
fit_3_dry_wd_int_summary_model_ind |> filter(rhat > 1.1)
fit_4_wet_wd_int_summary_model_ind |> filter(rhat > 1.1)
fit_5_dry_cn_noint_summary_model_ind |> filter(rhat > 1.1)
fit_6_wet_cn_noint_summary_model_ind |> filter(rhat > 1.1)
fit_7_dry_wd_noint_summary_model_ind |> filter(rhat > 1.1)
fit_8_wet_wd_noint_summary_model_ind |> filter(rhat > 1.1)
fit_9_dry_pca_int_summary_model_ind |> filter(rhat > 1.1)
fit_10_wet_pca_int_summary_model_ind |> filter(rhat > 1.1)
fit_11_dry_pca_noint_summary_model_ind |> filter(rhat > 1.1)
fit_12_wet_pca_noint_summary_model_ind |> filter(rhat > 1.1)
```


# Divergent transitions

```{r}
targets::tar_load(fit_1_dry_cn_int_diagnostics_model_ind)
targets::tar_load(fit_2_wet_cn_int_diagnostics_model_ind)
targets::tar_load(fit_3_dry_wd_int_diagnostics_model_ind)
targets::tar_load(fit_4_wet_wd_int_diagnostics_model_ind)
targets::tar_load(fit_5_dry_cn_noint_diagnostics_model_ind)
targets::tar_load(fit_6_wet_cn_noint_diagnostics_model_ind)
targets::tar_load(fit_7_dry_wd_noint_diagnostics_model_ind)
targets::tar_load(fit_8_wet_wd_noint_diagnostics_model_ind)
targets::tar_load(fit_9_dry_pca_int_diagnostics_model_ind)
targets::tar_load(fit_10_wet_pca_int_diagnostics_model_ind)
targets::tar_load(fit_11_dry_pca_noint_diagnostics_model_ind)
targets::tar_load(fit_12_wet_pca_noint_diagnostics_model_ind)
```

There were a few divergent transitions for model 10 (PCA with interactions for Rainy seasons) and model 12 (PCA without interactions for Rainy seasons).
I could increase `adapt_delta ` later but the current results look OK.

```{r}
div_check(fit_1_dry_cn_int_diagnostics_model_ind)
div_check(fit_2_wet_cn_int_diagnostics_model_ind)
div_check(fit_3_dry_wd_int_diagnostics_model_ind)
div_check(fit_4_wet_wd_int_diagnostics_model_ind)
div_check(fit_5_dry_cn_noint_diagnostics_model_ind)
div_check(fit_6_wet_cn_noint_diagnostics_model_ind)
div_check(fit_7_dry_wd_noint_diagnostics_model_ind)
div_check(fit_8_wet_wd_noint_diagnostics_model_ind)
div_check(fit_9_dry_pca_int_diagnostics_model_ind)
div_check(fit_10_wet_pca_int_diagnostics_model_ind)
div_check(fit_11_dry_pca_noint_diagnostics_model_ind)
div_check(fit_12_wet_pca_noint_diagnostics_model_ind)
```

# Model comparisons

## Dry seasons

PCA without interactions is the best model.
Model without CN and WD and withouth interactions (cn_noint) is the best for single traits models.

```{r}
targets::tar_load(dry_loo)
loo::loo_compare(
  dry_loo[[1]],
  wd_int = dry_loo[[2]],
  cn_noint = dry_loo[[3]],
  wd_noint = dry_loo[[4]],
  pca_int = dry_loo[[5]],
  pca_noint = dry_loo[[6]])
```

## Rainy seasons

PCA with interactions is the best model.
Model without WD and without interactions (cn_noint) is the best for single traits models.
Model without CN and WD looks OK too.

```{r}
targets::tar_load(wet_loo)
loo::loo_compare(
  wet_loo[[1]],
  wd_int = wet_loo[[2]],
  cn_noint = wet_loo[[3]],
  wd_noint = wet_loo[[4]],
  pca_int = wet_loo[[5]],
  pca_noint = wet_loo[[6]])
```

# Figs

## Dry

```{r}
targets::tar_load(fit1_tab)
targets::tar_load(dry_cn_int)
x_name <- colnames(dry_cn_int$x)
u_name <- rownames(dry_cn_int$u)

fit1_gamma <- fit1_tab |>
  filter(str_detect(para, "gamma")) |>
  mutate(pred_name = rep(x_name,  length(u_name))) |>
  mutate(trait_name = rep(u_name, each = length(x_name)))

fit1_gamma |>
  filter(lwr2_5 * upr97_5 > 0)

fit1_gamma |>
  filter(trait_name == "intercept")

```


```{r}

n_sp <- ncol(dry_cn_int$u)

fit1_beta <- fit1_tab |>
  filter(str_detect(para, "beta")) |>
  mutate(pred_name = rep(x_name,  n_sp)) |>
  mutate(sp_name = rep(paste0("sp_", 1:n_sp), each = length(x_name)))

targets::tar_load(fit_1_dry_cn_int_draws_model_ind)

tmp <- fit_1_dry_cn_int_draws_model_ind |>
    janitor::clean_names() |>
    dplyr::select(contains(c("beta")))

tmp2 <- pivot_longer(tmp, 1:ncol(tmp)) |>
  group_by(name) |>
  nest()

tmp3 <- tmp2 |>
  mutate(value = map(data, unlist)) |>
  mutate(density_= map(value, density)) |>
  mutate(x = map(density_, \(x)x$x)) |>
  mutate(y = map(density_, \(x)x$y)) |>
  mutate(max_y = map(y, max))

tmp4 <- tmp3 |>
  ungroup() |>
  mutate(pred_name = rep(x_name,  n_sp)) |>
  mutate(sp_name = rep(paste0("sp_", 1:n_sp), each = length(x_name))) |>
  dplyr::select(name, x, y, max_y, pred_name, sp_name) |>
  unnest() |>
  mutate(density = y / max_y)

ggplot(tmp4, aes(x = x, y = pred_name, gr = sp_name)) +
  geom_ridgeline(aes(height = density), fill = NA, colour = rgb(0, 0, 0, 0.1)) +
  theme_bw()

```



## Dry no interaction

```{r}
targets::tar_load(fit5_tab)
targets::tar_load(dry_cn_noint)
x_name2 <- colnames(dry_cn_noint$x)
u_name2 <- rownames(dry_cn_noint$u)

fit5_tab |>
  filter(str_detect(para, "gamma")) |>
  mutate(pred_name = rep(x_name2,  length(u_name2))) |>
  mutate(trait_name = rep(u_name2, each = length(x_name2))) |>
  filter(lwr2_5 * upr97_5 > 0)

fit5_tab |>
  filter(str_detect(para, "gamma")) |>
  mutate(pred_name = rep(x_name2,  length(u_name2))) |>
  mutate(trait_name = rep(u_name2, each = length(x_name2))) |>
  filter(trait_name == "intercept")

```

## Rainy

```{r}
targets::tar_load(fit2_tab)
targets::tar_load(wet_cn_int)
x_name <- colnames(wet_cn_int$x)
u_name <- rownames(wet_cn_int$u)

fit2_gamma <- fit2_tab |>
  filter(str_detect(para, "gamma")) |>
  mutate(pred_name = rep(x_name,  length(u_name))) |>
  mutate(trait_name = rep(u_name, each = length(x_name)))

fit2_gamma |>
  filter(lwr2_5 * upr97_5 > 0)

fit2_gamma |>
  filter(trait_name == "intercept")
```

# Session information

```{r}
devtools::session_info()
```

