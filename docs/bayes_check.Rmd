---
title: "Diagnostics for MCMC"
author: "Masatoshi Katabuchi"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    fig_caption: yes
    theme: spacelab #readable #sandstone #spacelab #flatly
    highlight: pygments #tango #kate
    toc: TRUE
    toc_depth: 2
    number_sections: TRUE
    toc_float:
     collapsed: TRUE
     smooth_scroll: TRUE
     toc: true
---


```{r global_options, include=FALSE}
library(knitr)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  cache = FALSE,
  fig.align = "center",
  fig.show = "hold"
)
```


```{r}
library(tidyverse)
library(patchwork)
library(here)
```

```{r}
source(here("R", "stan.R"))
```


# Model

Stan code for the multilevel logistic regression in the main text.

```{stan, file="stan/model_ind.stan", echo=TRUE, eval=FALSE, output.var="hoge"}
```

# Data

The object names and letters are as for the stan code above.

```{r, include=FALSE}
targets::tar_load(dry_each_int_s)
targets::tar_load(wet_each_int_s)
```

## Dry season

```{r}
dry_each_int_s |> str()
```

## Rainy season

```{r}
wet_each_int_s |> str()
```

# Convergence


```{r, include=FALSE}
targets::tar_load(fit_9_dry_each_int_s_summary_model_ind)
targets::tar_load(fit_10_wet_each_int_s_summary_model_ind)
```

Both models have converged (Rhat < 1.1).

```{r}
fit_9_dry_each_int_s_summary_model_ind |> filter(rhat > 1.1)
fit_10_wet_each_int_s_summary_model_ind |> filter(rhat > 1.1)
```


# Divergent transitions

```{r, include=FALSE}
targets::tar_load(fit_9_dry_each_int_s_diagnostics_model_ind)
targets::tar_load(fit_10_wet_each_int_s_diagnostics_model_ind)
```

There were no divergent transitions.

```{r}
div_check(fit_9_dry_each_int_s_diagnostics_model_ind)
div_check(fit_10_wet_each_int_s_diagnostics_model_ind)
```


# Tables

## Dry

```{r}
targets::tar_load(fit9_tab)
targets::tar_load(dry_each_int_s)

fit9_gamma <- create_gamma_tab(fit9_tab, dry_each_int_s)

fit9_gamma |>
  filter(lwr2_5 * upr97_5 > 0)

fit9_gamma |>
  filter(trait_name == "intercept")
```



## Rainy

```{r}
targets::tar_load(fit10_tab)
targets::tar_load(wet_each_int_s)
fit10_gamma <- create_gamma_tab(fit10_tab, wet_each_int_s)

fit10_gamma |>
  filter(lwr2_5 * upr97_5 > 0)

fit10_gamma |>
  filter(trait_name == "intercept")
```

# Figs

Thick and thin lines indicate 90% and 95% credible intervals, respectively.
Circles show posterior means of coefficients.
Filled circles indicate significant effects and open circles indicate non-significance effects.

```{r, include=FALSE}
targets::tar_load(coef_trait_int_s_plot)
```

![](../figs/coef_trait_int_s.png)


# Session information

```{r}
devtools::session_info()
```

