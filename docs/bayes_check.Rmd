---
title: "Diagnostics for MCMC"
author: "Masatoshi Katabuchi"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    fig_caption: yes
    theme: spacelab #readable #sandstone #spacelab #flatly
    highlight: pygments #tango #kate
    toc: TRUE
    toc_depth: 2
    number_sections: TRUE
    toc_float:
     collapsed: TRUE
     smooth_scroll: TRUE
     toc: true
---


```{r global_options, include=FALSE}
library(knitr)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  cache = FALSE,
  fig.align = "center",
  fig.show = "hold"
)
```


```{r}
library(tidyverse)
library(patchwork)
library(here)
```

```{r}
source(here("R", "stan.R"))
```


# Model

Stan code for the multilevel logistic regression in the main text.

```{stan, file="stan/model_ind.stan", echo=TRUE, eval=FALSE, output.var="hoge"}
```

# Data

The object names and letters are as for the stan code above.

```{r, include=FALSE}
targets::tar_load(dry_each_int_s)
targets::tar_load(wet_each_int_s)
```

## Dry season

```{r}
dry_each_int_s |> str()
```

## Rainy season

```{r}
wet_each_int_s |> str()
```

# Convergence


```{r, include=FALSE}
targets::tar_load(fit_9_dry_each_int_s_summary_model_ind)
targets::tar_load(fit_10_wet_each_int_s_summary_model_ind)
```

Both models have converged (Rhat < 1.1).

```{r}
fit_9_dry_each_int_s_summary_model_ind |> filter(rhat > 1.1)
fit_10_wet_each_int_s_summary_model_ind |> filter(rhat > 1.1)
```


# Divergent transitions

```{r, include=FALSE}
targets::tar_load(fit_9_dry_each_int_s_diagnostics_model_ind)
targets::tar_load(fit_10_wet_each_int_s_diagnostics_model_ind)
```

There were no divergent transitions.

```{r}
div_check(fit_9_dry_each_int_s_diagnostics_model_ind)
div_check(fit_10_wet_each_int_s_diagnostics_model_ind)
```


# Tables

## Dry

```{r}
targets::tar_load(fit9_tab)
targets::tar_load(dry_each_int_s)

fit9_gamma <- create_gamma_tab(fit9_tab, dry_each_int_s)

fit9_gamma |>
  filter(lwr2_5 * upr97_5 > 0)

fit9_gamma |>
  filter(trait_name == "intercept")
```

```{r}
fit9_gamma$trait_name |> unique()
library(kableExtra)

#str_split_fixed(fit9_gamma$para, "_" ,3)[,2]

fit9_gamma |>
  mutate(pred_name = case_when(
    pred_name == "int" ~ "Intercept",
    pred_name == "logh_scaled" ~ "log[Height]",
    pred_name == "cons_scaled" ~ "ConS",
    pred_name == "cona_scaled_c" ~ "ConT",
    pred_name == "hets_scaled" ~ "HetS",
    pred_name == "heta_scaled_c" ~ "HetT",
    pred_name == "rain_scaled" ~ "Rainfall",
    pred_name == "cons_rain" ~ "Cons $\\times$ Rainfall",
    pred_name == "cona_rain" ~ "ConT $\\times$ Rainfall",
    pred_name == "hets_rain" ~ "HetS $\\times$ Rainfall",
    pred_name == "heta_rain" ~ "HetT $\\times$ Rainfall"
  )) |>
  mutate(trait_name = case_when(
    trait_name == "intercept" ~ "Intercept",
    trait_name == "ldmc" ~ "LDMC",
    trait_name == "sdmc" ~ "SDMC",
    trait_name == "chl" ~ "Chl",
    trait_name == "c13" ~ "$\\delta C_{13}$",
    trait_name == "c_mass" ~ "C",
    trait_name == "n_mass" ~ "N",
    trait_name == "tlp" ~ "$\\pi_{tlp}$",
    trait_name == "log_la" ~ "log[LA]",
    trait_name == "log_sla" ~ "log[SLA]",
    trait_name == "log_lt" ~ "log[LT]")) |>
  mutate(para = paste0(
    "$\\gamma_{",
    str_split_fixed(fit9_gamma$para, "_" ,3)[,2],
    ",",
    str_split_fixed(fit9_gamma$para, "_" ,3)[,3],
    "}$")) |>
  # rename(Parameter = para) |>
  # rename(Mean = mean_) |>
  # rename(`Lower 2.5% CI` = lwr2_5) |>
  # rename(`Lower 5% CI` = lwr5) |>
  # rename(`Upper 95% CI` = upr95) |>
  # rename(`Upper 97.5% CI` = upr97_5) |>
  # rename(`Individual-level predictor` = pred_name) |>
  # rename(`Species-level predictor` = trait_name) |>
  kable(format = "html") |>
  kable_styling()

  #|
  #mutate(hoge = paste0("Effect of ", trait_name, " on ", pred_name))
```



```{r}
  # rename(Parameter = para) |>
  # rename(Mean = mean_) |>
  # rename(`Lower 2.5% CI` = lwr2_5) |>
  # rename(`Lower 5% CI` = lwr5) |>
  # rename(`Upper 95% CI` = upr95) |>
  # rename(`Upper 97.5% CI` = upr97_5) |>
  # rename(`Individual-level predictor` = pred_name) |>
  # rename(`Species-level predictor` = trait_name)
```



## Rainy

```{r}
targets::tar_load(fit10_tab)
targets::tar_load(wet_each_int_s)
fit10_gamma <- create_gamma_tab(fit10_tab, wet_each_int_s)

fit10_gamma |>
  filter(lwr2_5 * upr97_5 > 0)

fit10_gamma |>
  filter(trait_name == "intercept")
```

# Figs

Thick and thin lines indicate 90% and 95% credible intervals, respectively.
Circles show posterior means of coefficients.
Filled circles indicate significant effects and open circles indicate non-significance effects.

```{r, include=FALSE}
targets::tar_load(coef_trait_int_s_plot)
```

![](../figs/coef_trait_int_s.png)


# Session information

```{r}
devtools::session_info()
```

