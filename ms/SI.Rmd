---
geometry: margin=1in
link-citations: yes
csl: templates/american-journal-of-botany.csl
bibliography: Seedling.bib
fontsize: 12pt
#font-famliy: "ebgaramond"
header-includes:
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage{threeparttablex}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage{xcolor}
  - \usepackage{lineno}
  - \linenumbers
output:
  html_document:
    toc: FALSE
  pdf_document:
    keep_md: false
    fig_caption: yes
    keep_tex: yes
    toc: no
    number_sections: no
    template: templates/eisvogel2.tex
    #template: null
    pandoc_args:
      - "--filter"
      - "pandoc-crossref"
  bookdown::word_document2:
    fig_width: 6
    fig_caption: yes
    toc: FALSE
    reference_docx: templates/rmd_style.docx
    pandoc_args:
    - "--filter"
    - "pandoc-crossref"
    - "--mathml"
---

```{r caching, include=FALSE}
library(knitr)
library(tidyverse)
library(methods)
#source("../scripts/rmd_func.R")
#basename <- "LMA_method"
opts_chunk$set(fig.path = paste("figs/", sep=""))
opts_chunk$set(tidy=FALSE, warning=FALSE, message=FALSE,
               comment = NA, verbose = TRUE, echo=FALSE)
# PDF-based figures
opts_chunk$set(dev='pdf')

# https://github.com/haozhu233/kableExtra/issues/477
options(kableExtra.auto_format = FALSE)
library(kableExtra)

#val <- yaml::yaml.load_file("../values.yml")
```


$$
s_{i,j,m,t,p} \sim \mathcal{B}(p_{i, j, m, t, p})
$$

$$
\mathrm{logit}(p_{i,j,m,t,p}) = \boldsymbol{\beta_{j}} \cdot \boldsymbol{x_{i}} + \phi_p + \omega_t + \psi_m
$$

where $\boldsymbol{\beta_{j}} = \left[\beta_{j,1}, \beta_{j,2}, \ldots, \beta_{j,K} \right]$ is the coefficient *K*-vector for species *j*,
*K* is the number of predictors for an individual seedling,
$\boldsymbol{x_i} = \left[x_{1,i},x _{2,i}, \ldots,x_{K,i} \right]$ is the row vector of predictors of size *K* for an individual seedling,
$\phi_p$ is the random effect for seedling plots,
$\omega_t$ is the random effect for different census, and
$\psi_m$ is the random effect for the repeated observations of the same individuals
(note that $\cdot$ denotes dot product).
The set of predictor variables ($\boldsymbol{x_i}$) includes
intercept,
log of seedling heights,
rainfall,
densities of conspecific (CONS) and heterospecific (HETS) seedlings,
densities of conspecific (CONA) and heterospecific (HETA) adult trees that are scaled by 0.24 for the dry season or 0.27 for the rainy season,
and the interactions of rains with CONS, with HETS, with CONA and with HETA.

In the species-level regression, the vector of coefficients ($\boldsymbol{\beta_{1-K}}$) of each species *j* were assumed to have a multivariate normal distribution through the Cholesky factorization,

$$
\boldsymbol{\beta_j} = \boldsymbol{u_j} \cdot \boldsymbol{\gamma_k} + (\mathrm{diag}(\boldsymbol{\sigma})\cdot \boldsymbol{L} \cdot \boldsymbol{z})^\top
$$

where $\boldsymbol{u_{j}} = \left[u_{j,1}, u_{j,2}, \ldots, u_{j,L} \right]$ is the vector of predictors of size *L* for species *j*,
*L* is the number of predictors for each species (i.e., the number of traits including an intercept),
$\boldsymbol{\gamma_k} = \left[\gamma_{1,k}, \gamma_{2,k}, \ldots, \gamma_{L,k} \right]$ is the the coefficient *L*-vector for *k*th predictor in the individual-level regression,
$\mathrm{diag}(\boldsymbol{\sigma})$ is the diagonal matrix with the diagonal vector of coefficient scales,
$\boldsymbol{L}$ is the Cholesky factor of the original correlation matrix which can be derived using a Cholesky decomposition for the covariance matrix of the original multivariate normal distribution,
$\boldsymbol{z}$ is a *K* $\times$ *J* matrix of latent Gaussian variables,
*J* is the number of species, and
$\top$ denotes the conjugate transpose.
The set of predictor variables ($\boldsymbol{u_j}$) includes
LDMC,
SDMC,
LA,
SLA,
Chl,
LT,
C13,
C,
N,
CN, and
tlp (**need to edit here according to a trait description section**).

Posterior distributions of all parameters were estimated using the Hamiltonian Monte Carlo algorithm (HMC) implemented in Stan [@Carpenter2017] using the weakly-informative priors [@Gelman2008].
See supplement XXXX for more detail.
The Stan code use to fit models is available from Github at: XXXX.
Convergence of the posterior distribution was assessed with the Gelman-Rubin statistic with a convergence threshold of 1.1 for all parameters [@Gelman2013].

# SI text

## Model estimation

We fitted the parameters using laten Gaussian variables for the species-level coeffcient

\begin{align}
s_{i,j,m,t,p} &\sim \mathcal{B}(p_{i, j, m, t, p}) \\
\boldsymbol{\beta_j} &\sim \mathcal{MVN}(\boldsymbol{x_j} \cdot \boldsymbol{\gamma_k}, {\boldsymbol \Sigma_{\beta}})  \\
\gamma &\sim \mathcal{N}(0, 5) \\
L &\sim \mathrm{LkjCholesky}(2) \\
\tilde{\phi_p}, \tilde{\omega_t}, \tilde{\psi_m}, u &\sim \mathcal{N}(0, 1) \\
\tilde{\tau_{1-3}}, \tilde{\sigma_{1-3}} &\sim \mathcal{U}(0, \pi/2) \\
\beta &= x \cdot \gamma + (\mathrm{diag}(\sigma)\cdot L \cdot u)^\top \\
\tau_{1-3} &= 2.5 \times tan(\tilde{\tau_{1-3}}) \\
\sigma_{1-3} &= 2.5 \times tan(\tilde{\sigma_{1-3}}) \\
\phi_p &= \tau_1 \tilde{\phi_p} \\
\omega_t &= \tau_2 \tilde{\omega_t} \\
\psi_m &= \tau_3 \tilde{\psi_m} \\
\end{align}

parameter

\begin{align}
\mathrm{logit}(p_{i,j,m,t,p}) &= \boldsymbol{\beta_{j}} \cdot \boldsymbol{z_{i}} + \phi_p + \omega_t + \psi_m , \nonumber \\
\tau_{1-3} &= 2.5 \times tan(\tilde{\tau_{1-3}}), \nonumber \\
\sigma_{1-3} &= 2.5 \times tan(\tilde{\sigma_{1-3}}), \nonumber \\
\beta &= x \cdot \gamma + (\mathrm{diag}(\sigma)\cdot L \cdot u)^\top, \nonumber \\
\phi_p &= \tau_1 \tilde{\phi_p}, \nonumber \\
\omega_t &= \tau_2 \tilde{\omega_t}, \nonumber \\
\psi_m &= \tau_3 \tilde{\psi_m}
\end{align}


likelihood

\begin{align}
s_{i,j,m,t,p} &\sim \mathcal{B}(p_{i, j, m, t, p}) , \nonumber \\
\boldsymbol{\beta_j} &\sim \mathcal{MVN}(\boldsymbol{x_j} \cdot \boldsymbol{\gamma_k}, {\boldsymbol \Sigma_{\beta}}) , \nonumber \\
\tilde{\phi_p}, \tilde{\omega_t}, \tilde{\psi_m}, u &\sim \mathcal{N}(0, 1), \nonumber \\
\tilde{\tau_{1-3}}, \tilde{\sigma_{1-3}} &\sim \mathcal{U}(0, \pi/2), \nonumber \\
\gamma &\sim \mathcal{N}(0, 5), \nonumber \\
L &\sim \mathrm{LkjCholesky}(2)
\end{align}



The covariance matrix $\boldsymbol \Sigma_{\beta}$ can be decomposed as ${\boldsymbol \Sigma} = \mathrm {diag}({\boldsymbol \sigma}){\boldsymbol \Omega}\mathrm {diag}({\boldsymbol \sigma}) = \mathrm {diag}({\boldsymbol \sigma})\boldsymbol{LL}^\top \mathrm {diag}({\boldsymbol \sigma})$ using a Cholesky decomposition [@Alvarez2014],
where
$\boldsymbol{L}$ is a Cholesky factor of a correlation matrix ($\boldsymbol \Omega$),
$\boldsymbol{L}^\top$ is the conjugate transpose of $\boldsymbol{L}$, and
$\boldsymbol \sigma$ is the vector of coefficient scales.






## References