---
fontsize: 12pt
geometry: margin=1in
link-citations: true
csl: templates/ecology-letters.csl
bibliography: templates/seedling.bib
crossref:
  fig-title: Fig.
  fig-prefix: Fig.
  eq-prefix: Eq.
format:
  pdf:
    toc: false
    keep-tex: true
    pdf-engine: pdflatex
    include-in-header:
      text: |
        \usepackage{xr}
        \usepackage[default]{sourcesanspro}
        \usepackage{sourcecodepro}
        \usepackage{fancyhdr}
        \usepackage{fvextra}
        \usepackage{dcolumn}
        \pagestyle{fancy}
        \fancypagestyle{plain}{\pagestyle{fancy}}
        \renewcommand{\headrulewidth}{0pt}
        \fancyhead[RE,RO]{Song \textit{et al}. --Ecology-- Appendix}
        \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
  html:
    theme: spacelab #readable #sandstone #spacelab #flatly
    toc: true
    toc-depth: 2
    toc-title: Contents
    self-contained: true
    smooth-scroll: true
    highlight-style: github
    embed-resources: true
  docx:
    toc: false
    number-sections: false
    highlight-style: github
    html-math-method: katex
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```


```{r}
library(tidyverse)
library(patchwork)
library(here)
library(kableExtra)
```

```{r}
source(here("R", "stan.R"))
source(here("R", "render.R"))
source(here("R", "data_clean.R"))
```
# note

```{r}
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_load(seedling_df))

seedling_df |>
  group_by(season) |>
  summarise(n = n(), surv = sum(surv)) |>
  mutate(suv_rate = surv / n)

seedling_df |>
  group_by(season, year) |>
  summarise(n = n(), surv = sum(surv)) |>
  mutate(suv_rate = surv / n)
```


\newpage

# `r s_fig("site_info")`

Plot location in Xishuangbanna, China (A) and topography map (B) of the 20-ha plot and the components of a census station.
The numbers in the contour map are elevation (m), and the squares represent the locations of the 150 seed traps (B).
Each of the three 1-m2 seedling plots is 2 m away from the central seed trap (C).

![](`r here::here("data-raw/site_info.jpg")`)

\newpage

# `r s_fig("rainfall")`

Seasonal rainfall pattern in this area (data from November 2007- November 2017), November to April is the dry season (red bars), and May to October is the rainy season (blue bars).

![](`r here::here("data-raw/rainfall.jpg")`)

\newpage

# `r s_fig("pairs")`

A pairwise plot matrix of functional traits used in this study.
The diagonal displays density plots of each variable,
the upper diagonal shows the Pearson correlation coefficients between pairs of variables, and
the lower diagonal presents scatter plots of the variable pairs.
LDMC: leaf dry matter content,
SD: stem density,
SDMC: stem dry matter content,
Chl: chlorophyll content,
C13: stable carbon isotope composition,
C: carbon concentration,
N: nitrogen concentration,
CN: carbon nitrogen ratio,
tlp: leaf turgor loss point,
LA: leaf area,
SLA: specific leaf area,
LT: leaf thickness.
N, LA, SLA, and LT are natural log-transformed.

![](`r here::here("figs/pairs.pdf")`)

\newpage

# `r s_fig("pca")`

I will add texts.

![](`r here::here("figs/pca_panel.png")`)

\newpage

# `r s_fig("phy")`

I will add texts.

![](`r here::here("figs/phy_het.png")`)

\newpage


# `r s_fig("cc_line")`

The grid-search for the scaling parameter *c* that maximized the likelihood of the following survival model:
$\mathrm{logit}(p_i) = b_0 + b_1 Z_{1i}^c + b_2 Z_{2i}^c$,
where $p_i$ is the individual survival probability, $Z_1$ and $Z_2$ are distance-weighted sums of basal area of conspecific and heterospecific densities.

![](`r here::here("figs/cc_line.pdf")`)

\newpage

# `r s_append("method")` - Extended model description

<Should we remove this? But it's too much to explain about $\Omega_L$ in the main text.>

We modeled the seedling survival for the dry and rainy seasons separately.
Since the effect of tree neighbors on seedling survival is nonlinear on a logistic scale [@Detto2019], we performed a grid-search for the scaling parameter *c* between 0 and 1 in 0.01 increments that maximized the likelihood of the following survival model,

$$
\mathrm{logit}(p_i) = b_0 + b_1 Z_{1i}^c + b_2 Z_{2i}^c,
$$

where $p_i$ is the survival probability of the *i*th individual, and $Z_1$ and $Z_2$ are distance-weighted sums of basal areas of conspecifics and heterospecifics respectively.
We found that $c$ = 0.27 for the dry season and $c$ = 0.24 for the rainy season were the best estimates for our dataset (`r s_fig("cc_line")`).

We built Bayesian hierarchical models that include variation among species in the effects of conspecific and heterospecific neighbours, and rainfall on survival.
Survival ($s$) of seedling record *i* of individual *m* for species *j* in census *t* in plot *p* was modeled using the Bernoulli distribution ($\mathcal{B}$):

$$
s_{i,j,m,t,p} \sim \mathcal{B}(p_{i, j, t, p}),
$$

$$
\mathrm{logit}(p_{i,j,t,p}) = \boldsymbol{x_{i}} \cdot \boldsymbol{\beta_{j}} + \phi_p + \omega_t,
$$

where $\boldsymbol{\beta_{j}} = \left[\beta_{1,j}, \beta_{2,j}, \ldots, \beta_{K,j} \right]$ is the coefficient row *K*-vector for species *j*,
*K* is the number of predictors for an individual seedling,
$\boldsymbol{x_i} = \left[x_{i,1},x _{i,2}, \ldots,x_{i,K} \right]$ is the vector of predictors of size *K* for an individual seedling,
$\phi_p$ is the random effect for seedling plots, and
$\omega_t$ is the random effect for different censuses
(note that $\cdot$ denotes dot product).
The set of predictor variables ($\boldsymbol{x_i}$) includes
intercepts,
log of seedling heights,
rainfall,
densities of conspecific (*ConS*) and heterospecific (*HetS*) seedlings,
densities of conspecific (*ConA*) and heterospecific (*HetA*) trees that are scaled by 0.27 for the dry season or 0.24 for the rainy season,
and the interactions of rains with *ConS*, with *HetS*, with *ConA* and with *HetA*.
We also considered models with phylogenetic density effects instead of heterospecific density effects.

In the species-level regression, the row vector of coefficients ($\boldsymbol{\beta_{1-K}}$) of each species *j* were assumed to have a multivariate normal distribution through the Cholesky factorization [@StanDevelopmentTeam2021],

$$
\boldsymbol{\beta_j} = \boldsymbol{\gamma_k} \cdot \boldsymbol{u_j} + \mathrm{diag}(\boldsymbol{\tau})\cdot \boldsymbol{\Omega_L} \cdot \boldsymbol{z},
$$

where $\boldsymbol{u_{j}} = \left[u_{1,j}, u_{2,j}, \ldots, u_{L,j} \right]$ is the row vector of predictors of size *L* for species *j*,
*L* is the number of predictors for each species (i.e., the number of traits including an intercept),
$\boldsymbol{\gamma_k} = \left[\gamma_{k,1}, \gamma_{k,2}, \ldots, \gamma_{k,L} \right]$ is the coefficient *L*-vector for *k*th predictor in the individual-level regression,
$\mathrm{diag}(\boldsymbol{\tau})$ is the diagonal matrix with the diagonal vector of coefficient scales,
$\boldsymbol{\Omega_L}$ is the Cholesky factor of the original correlation matrix, which can be derived using a Cholesky decomposition for the covariance matrix of the original multivariate normal distribution,
$\boldsymbol{z}$ is a *K* $\times$ *J* matrix of latent Gaussian variables, and
*J* is the number of species.
We modeled five different sets of species-level predictors separately.
The set of species-level predictor variables ($\boldsymbol{u_j}$) includes
1)
LDMC,
SDMC,
LA,
SLA,
Chl,
LT,
$\delta$C~13~,
C,
N, and
$\pi$~tlp~,
2) abundance,
3) basal area, and
4) abundance and basal area.
The row vector $\gamma_{k,1}$ represents the average effects of each individual-level predictor (e.g., *ConS*) across species,
whereas $\gamma_{k, l}$ ($l \ne 1$), represents the effects of the *l*-th individual-level predictor (e.g., SLA) on the variation in the strength of each individual-level predictor (e.g., variation in the strength of *ConS* among species).
To allow comparisons among parameter estimates, the individual-level predictors ($\boldsymbol{x_i}$) and the species-level predictors ($\boldsymbol{u_j}$) were scaled to a mean of 0 and standard deviation of 1 within each season and across species, respectively.

Posterior distributions of all parameters were estimated using the
No-U-Turn Sampler (NUTS), an adaptive variant of the Hamiltonian Monte Carlo (HMC), algorithm implemented in Stan [@Carpenter2017] using the weakly-informative priors [@Gelman2008].
The HMC algorithm uses gradient information to propose new states in the Markov chain, leading to a more efficient exploration of the target distribution than traditional Markov chain Monte Carlo (MCMC) methods that rely on random proposals [@Carpenter2017].
The NUTS algorithm automatically determines the number of Hamiltonian dynamics simulation steps needed to propose a new state in the Markov chain without requiring the user to set a fixed number of steps manually [@Hoffman2014].
Prior distributions for the species-level predictors ($\boldsymbol{\gamma_k}$) were independent normal distributions with a mean of 0 and standard deviation of 2.5;
prior distributions for the latent Gaussian variables ($\boldsymbol{z}$) were independent standard normal distributions.
A prior distribution for the Cholesky factor of the correlation matrix ($\boldsymbol{\Omega_L}$) was the Cholesky LKJ correlation distribution with a parameter of 2 (which indicates matrices with smaller correlations).
Four independent chains were run for 1,000 iterations for each model with a warm-up of 2,000 iterations.
Convergence of the posterior distribution was assessed with the Gelman-Rubin statistic with a convergence threshold of 1.1 [@Gelman2013] and effective sample sizes > 400 [@Vehtari2021] for all parameters.
Divergent transitions were also monitored.
The existence of divergent transitions suggests that estimates are based on the incomplete exploration of the simulated Hamiltonian trajectory and are not trusted [@Betancourt2016].

All statistical analyses were conducted in R version 4.2.1 [@RCoreTeam2022] using the R package *targets* version 0.13.5 for workflow management [@Landau2021].
Codes and datasets are available at
<https://github.com/mattocci27/trait-ndd>
and
<https://doi.org/10.57760/sciencedb.02276>
respectively.

\newpage

# `r s_append("code")` - Stan code

Stan code for the multilevel logistic regression in the main text.

<!-- ```{stan, file="stan/logistic_simple.stan", echo=TRUE, eval=FALSE, output.var="hoge"}
``` -->

```{stan, file="../stan/suv_ind.stan", echo=TRUE, eval=FALSE, output.var="hoge"}
```

\newpage

# `r s_table("pre_glm")`

I will clean the table.

```{r}
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_load(fit_glm_phy))
withr::with_dir(rprojroot::find_root('_targets.R'),
  targets::tar_load(fit_glm_het))

bind_rows(fit_glm_het, fit_glm_phy ) |>
    mutate(across(where(is.numeric), \(x)round(x, 3))) |>
    kbl(booktabs = TRUE, escape = TRUE, format = "latex", longtable = TRUE) |>
    kable_styling(latex_options = c("striped", "scale_down", "HOLD_position", "repeat_header"),
      full_width = FALSE) |>
    pack_rows("Heterospecific density", 1, 12) |>
    pack_rows("Phylogenetic density", 13, 24)
```

\newpage

```{r}
diagnostics_tbl <- read_csv(here("data/diagnostics_tables.csv"))
```


# `r s_table("dry_traits_diagnostics")`

Model selection and diagnostics for the dry season trait-based models.
Each model considers different aspects of rainfall effects:

- **No Rainfall**: Excludes rainfall effects.
- **Rainfall**: Includes rainfall effects without interactions.
- **All predictors × Rainfall**: Considers rainfall effects and all possible interactions.
- **ConS × Rainfall**: Focuses on the interaction between rainfall effects and conspecific seedling density.
- **ConT × Rainfall**: Focuses on the interaction between rainfall effects and conspecific tree density.
- **(ConS + ConT) × Rainfall**: Combines the interactions of rainfall effects with both conspecific seedling and tree densities.

Metrics Key:

- **ELPD**: expected log pointwise predictive density (larger values indicate better a model fit).
- **LOOIC**: leave-one-out deviance information criterion (smaller values indicate a better model fit).
- **N_ESS**: number of variables that showed effective sample size less than 400.
- **N_Div**: number of divergent transitions.

Models shown in grey are those with suboptimal convergence.

```{r}
render_diagnostics_tables(diagnostics_tbl, season = "dry", abund = FALSE)
```

\newpage

# `r s_table("wet_traits_diagnostics")`

Model selection and diagnostics for the rainy season trait-based models.
Details as for `r s_table("dry_traits_diagnostics")`.

```{r}
render_diagnostics_tables(diagnostics_tbl, season = "wet", abund = FALSE)
```
\newpage

# `r s_table("dry_abund_diagnostics")`

Model selection and diagnostics for the dry season abundance-based models.
Details as for `r s_table("dry_traits_diagnostics")`.

```{r}
render_diagnostics_tables(diagnostics_tbl, season = "dry", abund = TRUE)
```

\newpage

# `r s_table("wet_abund_diagnostics")`

Model selection and diagnostics for the rainy abundance-based models.
Details as for `r s_table("dry_traits_diagnostics")`.

```{r}
render_diagnostics_tables(diagnostics_tbl, season = "wet", abund = TRUE)
```

\newpage


```{r, include=FALSE}
dry_traits_gamma <- read_csv(here("data", "dry_intrain2_nlog_gamma.csv"))
```

# `r s_table("dry_traits_gamma")`

<I will update the caption.>

Posterior medians and 95% credible intervals (CIs) of the effects of species-level predictors (traits) on individual-level predictors ($\gamma$) in the dry seasons.
Bold values differ significantly from zero (the 95% CIs do not include zero).
ConS/HetS: conspecific/heterospecific seedling density,
ConT/HetT: conspecific/heterospecific tree density (scaled by 0.27),
LDMC: leaf dry matter content,
SDMC: stem dry matter content,
Chl: chlorophyll content,
$\delta$C~13~: stable carbon isotope composition,
C: carbon concentration,
N: nitrogen concentration,
$\pi$~tlp~: leaf turgor loss point,
LA: leaf area,
SLA: specific leaf area,
LT: leaf thickness.


```{r}
gen_si_tab(dry_traits_gamma)
```

\newpage

# `r s_table("dry_pca_gamma")`

Posterior medians and 95% credible intervals (CIs) of the effects of species-level predictors (PC) on individual-level predictors ($\gamma$) in the dry seasons.
Conspecific (ConT) and heterospecific (HetT) tree densities are scaled by 0.24.
Other details as for `r s_table("dry_traits_gamma")`.

```{r, include=FALSE}
dry_pca_gamma <- read_csv(here("data", "dry_intrain_pc12_gamma.csv"))
```

```{r}
gen_si_tab(dry_pca_gamma)
```

\newpage

# `r s_table("wet_traits_gamma")`

Posterior medians and 95% credible intervals (CIs) of the effects of species-level predictors (traits) on individual-level predictors ($\gamma$) in the rainy seasons.
Conspecific (ConT) and phylogenetic (PhyT) tree densities are scaled by 0.27.
Other details as for `r s_table("dry_traits_gamma")`.

```{r, include=FALSE}
wet_traits_gamma <- read_csv(here("data", "wet_intrain2_nlog_gamma.csv"))
```

```{r}
gen_si_tab(wet_traits_gamma)
```

\newpage

# `r s_table("wet_pca_gamma")`

<PCA result might change>

Posterior medians and 95% credible intervals (CIs) of the effects of species-level predictors (PC) on individual-level predictors ($\gamma$) in the rainy seasons.
Conspecific (ConT) and heterospecific (HetT) tree densities are scaled by 0.27.
Other details as for `r s_table("dry_traits_gamma")`.

```{r, include=FALSE}
wet_pca_gamma <- read_csv(here("data", "wet_intrain_pc12_gamma.csv"))
```

```{r}
gen_si_tab(wet_pca_gamma)
```

\newpage

# `r s_table("dry_abund_gamma")`

Posterior medians and 95% credible intervals (CIs) of the effects of species-level predictors (abundance) on individual-level predictors ($\gamma$) in the dry seasons.
Conspecific (ConT) and phylogenetic (PhyT) tree densities are scaled by 0.27.
Other details as for `r s_table("dry_traits_gamma")`.

```{r, include=FALSE}
dry_abund_gamma <- read_csv(here("data", "dry_intrain_ab_gamma.csv"))
```

```{r}
gen_si_tab(dry_abund_gamma)
```

\newpage

# `r s_table("wet_abund_gamma")`

Posterior medians and 95% credible intervals (CIs) of the effects of species-level predictors (abundance) on individual-level predictors ($\gamma$) in the dry seasons.
Conspecific (ConT) and phylogenetic (PhyT) tree densities are scaled by 0.24.
Other details as for `r s_table("dry_abund_gamma")`.

```{r, include=FALSE}
wet_abund_gamma <- read_csv(here("data", "wet_intrain_ab_gamma.csv"))
```

```{r}
gen_si_tab(wet_abund_gamma)
```

\newpage

# References

```{r}
knitr::knit_exit()
```


```{r}
library(tidyverse)
library(targets)

d <- tar_read(dry_trait)
s <- tar_read(fit_summary_suv_ind_dry_intrain2_nlog)
data <- tar_read(stan_data_dry_intrain2_nlog)
u <- data$u

gamma_v <- s |>
  filter(str_detect(variable, "gamma")) |> pull(q50)
gamma <- matrix(gamma_v, nrow = 8)

beta_pre <- gamma %*% u
cons_pre <- beta_pre[3,]

beta <- s |>
  filter(str_detect(variable, "beta\\[3")) |>
  pull(q50)
res <- beta - cons_pre + u[3, ] * gamma[3, 3]
plot(u[3,],  res)

#==
draws <- d$draws |>
  janitor::clean_names()

gamma <- draws |>
  select(starts_with("gamma"))
beta <- draws |>
  select(starts_with("beta_3"))

df <- gamma
i <- 1
# Function to create a single matrix from a subset of columns

create_matrix <- function(df, i) {
  # Extract posteriors for the current matrix
  tmp <- df[i, ]　
  # Convert these columns into a matrix
  matrix(as.numeric(tmp), nrow = 8, ncol = 10)
}

gamma_list <- map(1:nrow(gamma), ~ create_matrix(gamma, .x))
pre_list <- map(gamma_list, ~ .x %*% u)

pre_3_list <- map(pre_list, ~ .x[3, ])
beta_list <- map(1:nrow(beta), ~ unlist(beta[.x, ]))

res_list <- list()
for (i in 1:8000) {
  res_list[[i]] <- beta_list[[i]] - pre_3_list[[i]] + u[3, ] * gamma_list[[i]][3, 3]
}

m <- map_dbl(1:73, ~ quantile(map_dbl(res_list, .x), 0.5))
l <- map_dbl(1:73, ~ quantile(map_dbl(res_list, .x), 0.025))
h <- map_dbl(1:73, ~ quantile(map_dbl(res_list, .x), 0.975))

tibble(m, l, h, sdmc = u[3,]) |>
  ggplot(aes(x = sdmc)) +
  geom_point(aes(y = m)) +
  geom_errorbar(aes(ymin = l, ymax = h))

```
